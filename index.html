<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Desire Tracker</title>
  <style>
    /* ---------- Global Styles ---------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* ---------- Header Section ---------- */
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: #4a5568;
      font-size: 1.125rem;
    }

    /* ---------- Authentication Section ---------- */
    .auth-section {
      background: #f7fafc;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .user-profile {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem;
      background: #fff;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }

    .user-profile.active {
      display: flex;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #667eea;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .user-name {
      font-weight: 600;
      color: #2d3748;
    }

    .user-email {
      color: #718096;
      font-size: 0.875rem;
    }

    /* ---------- Buttons ---------- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .btn-google {
      background: #fff;
      color: #4a5568;
      border: 1px solid #e2e8f0;
      margin: 0 auto;
    }

    .btn-google:hover {
      background: #f7fafc;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: #fc8181;
      color: #fff;
    }

    .btn-danger:hover {
      background: #f56565;
    }

    .btn-primary {
      background: #667eea;
      color: #fff;
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    /* ---------- Desire Form ---------- */
    .desire-form {
      display: grid;
      gap: 1.25rem;
      margin-bottom: 2rem;
      background: #fff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .form-group {
      display: grid;
      gap: 0.5rem;
    }

    .form-group label {
      font-weight: 600;
      color: #4a5568;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }

    /* ---------- Desires List ---------- */
    .desires-list {
      display: grid;
      gap: 1.25rem;
    }

    .desire-card {
      background: #fff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .desire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .desire-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2d3748;
    }

    .priority-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .priority-high {
      background: #fed7d7;
      color: #c53030;
    }

    .priority-medium {
      background: #feebc8;
      color: #c05621;
    }

    .priority-low {
      background: #c6f6d5;
      color: #2f855a;
    }

    .desire-description {
      color: #4a5568;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .desire-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    .desire-date {
      color: #718096;
      font-size: 0.875rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1.5rem;
      color: #718096;
    }

    /* ---------- Toasts ---------- */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 50;
    }

    .toast {
      background: #fff;
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ---------- Loading Overlay ---------- */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #fff;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ---------- Header ---------- -->
    <header class="header">
      <h1>✨ Desire Tracker</h1>
      <p>Transform your dreams into reality</p>
    </header>

    <!-- ---------- Auth Section ---------- -->
    <section class="auth-section">
      <!-- User Profile (hidden by default) -->
      <div id="userProfile" class="user-profile">
        <div class="user-info">
          <img id="userAvatar" class="user-avatar" alt="Profile Image" />
          <div class="user-details">
            <span id="userName" class="user-name"></span>
            <span id="userEmail" class="user-email"></span>
          </div>
        </div>
        <button id="signOutBtn" class="btn btn-danger">🚪 Sign Out</button>
      </div>

      <!-- Sign In Button (shown by default) -->
      <button id="signInBtn" class="btn btn-google">
        <img
          src="https://www.google.com/favicon.ico"
          alt="Google Icon"
          width="20"
          height="20"
        />
        Sign in with Google
      </button>
    </section>

    <!-- ---------- Main Content (hidden until user is authenticated) ---------- -->
    <main id="mainContent" style="display: none;">
      <!-- Form to add a new desire -->
      <form id="desireForm" class="desire-form">
        <div class="form-group">
          <label for="desireTitle">What's your desire?</label>
          <input
            type="text"
            id="desireTitle"
            class="form-control"
            required
            placeholder="Enter your desire..."
          />
        </div>

        <div class="form-group">
          <label for="desireDescription">Description</label>
          <textarea
            id="desireDescription"
            class="form-control"
            placeholder="Describe your desire in detail..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="desirePriority">Priority Level</label>
          <select id="desirePriority" class="form-control">
            <option value="low">Low Priority</option>
            <option value="medium">Medium Priority</option>
            <option value="high">High Priority</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">➕ Add Desire</button>
      </form>

      <!-- Container for listing the desires -->
      <div id="desiresList" class="desires-list"></div>
    </main>
  </div>

  <!-- ---------- Toast Container ---------- -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- ---------- Loading Overlay ---------- -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- ---------- Script: Firebase + App Logic ---------- -->
  <script type="module">
    /* ----------------- Firebase Imports ----------------- */
    import { 
      initializeApp 
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';

    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    import {
      getFirestore,
      collection,
      query,
      orderBy,
      getDocs,
      addDoc,
      deleteDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    /* ----------------- Firebase Configuration ----------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCLfBy9R_tL8WPRJpmKZMcy70OzhId9V1w",
      authDomain: "desires-b59a7.firebaseapp.com",
      projectId: "desires-b59a7",
      storageBucket: "desires-b59a7.appspot.com", /* <-- Make sure this matches your actual storage bucket */
      messagingSenderId: "942109661123",
      appId: "1:942109661123:web:84f2532a442f9d49bb8f76"
    };

    /* ----------------- Initialize Firebase ----------------- */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /* ----------------- Utility Methods ----------------- */
    const utils = {
      showLoading() {
        document.getElementById("loadingOverlay").classList.add("active");
      },
      hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("active");
      },
      formatDate(dateStr) {
        return new Date(dateStr).toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      },
      showToast(message, type = "success") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = "toast";

        const icon = type === "success" ? "✅" 
                  : type === "error"   ? "❌"
                  : "🔔";

        toast.innerHTML = `
          <span>${icon}</span>
          <span>${message}</span>
        `;
        container.appendChild(toast);

        // Remove toast after 3 seconds
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    };

    /* ----------------- Main Application Class ----------------- */
    class DesireTracker {
      constructor() {
        this.currentUser = null;
        this.desires = [];
        this.bindElements();
        this.bindEvents();
        this.monitorAuthState();
      }

      // Grab all DOM elements we need
      bindElements() {
        this.elements = {
          mainContent: document.getElementById("mainContent"),
          userProfile: document.getElementById("userProfile"),
          userAvatar: document.getElementById("userAvatar"),
          userName: document.getElementById("userName"),
          userEmail: document.getElementById("userEmail"),
          signInBtn: document.getElementById("signInBtn"),
          signOutBtn: document.getElementById("signOutBtn"),
          desireForm: document.getElementById("desireForm"),
          desiresList: document.getElementById("desiresList"),
        };
      }

      // Attach event listeners
      bindEvents() {
        this.elements.signInBtn.addEventListener("click", () => this.signInWithGoogle());
        this.elements.signOutBtn.addEventListener("click", () => this.signOutUser());
        this.elements.desireForm.addEventListener("submit", (e) => this.onFormSubmit(e));
      }

      // Monitor authentication state changes
      monitorAuthState() {
        onAuthStateChanged(auth, async (user) => {
          this.currentUser = user;
          this.updateUIForAuth();
          if (user) {
            // Load the user's desires once logged in
            await this.fetchDesires();
          } else {
            // Clear data when logged out
            this.desires = [];
            this.renderDesires();
          }
        });
      }

      /* ---------- Auth Methods ---------- */
      async signInWithGoogle() {
        try {
          utils.showLoading();
          const result = await signInWithPopup(auth, provider);
          utils.showToast(`Welcome, ${result.user.displayName}! 🎉`);
        } catch (err) {
          console.error("Error signing in:", err);
          utils.showToast(
            err.code === "auth/popup-closed-by-user"
              ? "Sign-in cancelled by user."
              : "Sign-in failed. Please try again.",
            "error"
          );
        } finally {
          utils.hideLoading();
        }
      }

      async signOutUser() {
        try {
          utils.showLoading();
          await signOut(auth);
          utils.showToast("Successfully signed out. 👋");
        } catch (err) {
          console.error("Error signing out:", err);
          utils.showToast("Failed to sign out.", "error");
        } finally {
          utils.hideLoading();
        }
      }

      /* ---------- UI Updates ---------- */
      updateUIForAuth() {
        if (this.currentUser) {
          // Show user profile
          this.elements.userProfile.classList.add("active");
          this.elements.userAvatar.src = this.currentUser.photoURL || "";
          this.elements.userName.textContent = this.currentUser.displayName || "";
          this.elements.userEmail.textContent = this.currentUser.email || "";

          // Hide Sign In button, show main content
          this.elements.signInBtn.style.display = "none";
          this.elements.mainContent.style.display = "block";
        } else {
          // Hide user profile
          this.elements.userProfile.classList.remove("active");
          // Show Sign In button, hide main content
          this.elements.signInBtn.style.display = "inline-flex";
          this.elements.mainContent.style.display = "none";
        }
      }

      /* ---------- Desires Logic ---------- */
      async onFormSubmit(e) {
        e.preventDefault();
        if (!this.currentUser) {
          utils.showToast("Please sign in first.", "error");
          return;
        }

        const title = this.elements.desireForm.desireTitle.value.trim();
        const description = this.elements.desireForm.desireDescription.value.trim();
        const priority = this.elements.desireForm.desirePriority.value;

        if (!title) {
          utils.showToast("Please enter a title for your desire.", "error");
          return;
        }

        const newDesire = {
          title,
          description,
          priority,
        };

        try {
          utils.showLoading();
          await this.addDesire(newDesire);
          this.elements.desireForm.reset();
          utils.showToast("Desire added successfully! 🌟");
        } catch (err) {
          console.error("Error adding desire:", err);
          utils.showToast("Failed to add desire.", "error");
        } finally {
          utils.hideLoading();
        }
      }

      async addDesire(desireData) {
        if (!this.currentUser) throw new Error("User not authenticated.");

        const docRef = collection(db, "users", this.currentUser.uid, "desires");
        await addDoc(docRef, {
          ...desireData,
          userId: this.currentUser.uid,
          createdAt: new Date().toISOString(),
        });
        // Refresh list
        await this.fetchDesires();
      }

      async fetchDesires() {
        if (!this.currentUser) return;
        try {
          utils.showLoading();
          const desiresRef = collection(db, "users", this.currentUser.uid, "desires");
          const q = query(desiresRef, orderBy("createdAt", "desc"));
          const snapshot = await getDocs(q);

          this.desires = snapshot.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));

          this.renderDesires();
        } catch (err) {
          console.error("Error fetching desires:", err);
          utils.showToast("Failed to fetch desires.", "error");
        } finally {
          utils.hideLoading();
        }
      }

      async deleteDesire(id) {
        if (!this.currentUser) throw new Error("User not authenticated.");

        try {
          utils.showLoading();
          const docRef = doc(db, "users", this.currentUser.uid, "desires", id);
          await deleteDoc(docRef);
          utils.showToast("Desire deleted successfully.");
          // Refresh list
          await this.fetchDesires();
        } catch (err) {
          console.error("Error deleting desire:", err);
          utils.showToast("Failed to delete desire.", "error");
        } finally {
          utils.hideLoading();
        }
      }

      /* ---------- Render ---------- */
      renderDesires() {
        const listEl = this.elements.desiresList;
        listEl.innerHTML = "";

        if (this.desires.length === 0) {
          listEl.innerHTML = `
            <div class="empty-state">
              <h3>No desires added yet</h3>
              <p>Start by adding your first desire above! 🚀</p>
            </div>
          `;
          return;
        }

        const cardsHtml = this.desires.map((des) => {
          const priorityClass = `priority-${des.priority}`;

          return `
            <div class="desire-card">
              <div class="desire-header">
                <h3 class="desire-title">${des.title}</h3>
                <span class="priority-badge ${priorityClass}">
                  ${des.priority.charAt(0).toUpperCase() + des.priority.slice(1)}
                </span>
              </div>
              <p class="desire-description">
                ${des.description || "No description provided"}
              </p>
              <div class="desire-footer">
                <span class="desire-date">
                  ${utils.formatDate(des.createdAt)}
                </span>
                <button
                  class="btn btn-danger"
                  onclick="app.deleteDesire('${des.id}')"
                >
                  🗑️ Delete
                </button>
              </div>
            </div>
          `;
        });

        listEl.innerHTML = cardsHtml.join("");
      }
    }

    // Expose the app instance globally so we can call deleteDesire from inline HTML
    window.app = new DesireTracker();
  </script>
</body>
</html>
